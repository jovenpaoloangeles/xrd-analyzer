var ws=Object.defineProperty;var Jt=P=>{throw TypeError(P)};var ps=(P,C,B)=>C in P?ws(P,C,{enumerable:!0,configurable:!0,writable:!0,value:B}):P[C]=B;var Xt=(P,C,B)=>ps(P,typeof C!="symbol"?C+"":C,B),Tt=(P,C,B)=>C.has(P)||Jt("Cannot "+B);var H=(P,C,B)=>(Tt(P,C,"read from private field"),B?B.call(P):C.get(P)),Nt=(P,C,B)=>C.has(P)?Jt("Cannot add the same private member more than once"):C instanceof WeakSet?C.add(P):C.set(P,B),Et=(P,C,B,at)=>(Tt(P,C,"write to private field"),at?at.call(P,B):C.set(P,B),B),qt=(P,C,B)=>(Tt(P,C,"access private method"),B);(function(){"use strict";var ct,Dt,nt,Y;const P=(n,r,e,t=1)=>{const s=new Array(r.length).fill(0);return C(n,r[0],r[r.length-1],e).forEach(i=>{const l=i.twoTheta,h=B(n,i)*t,a=.2/(2*Math.sqrt(2*Math.log(2)));r.forEach((f,w)=>{const d=f-l,m=1/(a*Math.sqrt(2*Math.PI))*Math.exp(-(d*d)/(2*a*a));s[w]+=h*m})}),s},C=(n,r,e,t)=>{const s=[];for(let i=-5;i<=5;i++)for(let l=-5;l<=5;l++)for(let h=-5;h<=5;h++){if(i===0&&l===0&&h===0)continue;const u=i*i/(n.a*n.a)+l*l/(n.b*n.b)+h*h/(n.c*n.c),a=1/Math.sqrt(u),f=t/(2*a);if(f>1)continue;const w=2*Math.asin(f)*(180/Math.PI);w>=r&&w<=e&&s.push({h:i,k:l,l:h,twoTheta:w})}return s},B=(n,r,e)=>{let t=0,s=0;n.atoms.forEach(u=>{const a=2*Math.PI*(r.h*u.x+r.k*u.y+r.l*u.z),f=at(u.symbol);t+=f*u.occupancy*Math.cos(a),s+=f*u.occupancy*Math.sin(a)});const o=t*t+s*s,i=r.twoTheta/2*(Math.PI/180),l=r.twoTheta*(Math.PI/180),h=(1+Math.pow(Math.cos(l),2))/(Math.pow(Math.sin(i),2)*Math.cos(i));return o*h},at=n=>({Si:14,O:8,Au:79,Cu:29})[n]||10,Kt=Object.prototype.toString;function ft(n){return Kt.call(n).endsWith("Array]")}function Zt(n,r,e){let{timeout:t,minValues:s,maxValues:o,initialValues:i,weights:l=1,damping:h=.01,dampingStepUp:u=11,dampingStepDown:a=9,maxIterations:f=100,errorTolerance:w=1e-7,centralDifference:d=!1,gradientDifference:m=.1,improvementThreshold:p=.001}=e;if(h<=0)throw new Error("The damping option must be a positive number");if(!n.x||!n.y)throw new Error("The data parameter must have x and y elements");if(!ft(n.x)||n.x.length<2||!ft(n.y)||n.y.length<2)throw new Error("The data parameter elements must be an array with more than 2 points");if(n.x.length!==n.y.length)throw new Error("The data parameter elements must have the same size");let S=i||new Array(r.length).fill(1),c=n.y.length,M=S.length;if(o=o||new Array(M).fill(Number.MAX_SAFE_INTEGER),s=s||new Array(M).fill(Number.MIN_SAFE_INTEGER),o.length!==s.length)throw new Error("minValues and maxValues must be the same size");if(!ft(S))throw new Error("initialValues must be an array");if(typeof m=="number")m=new Array(S.length).fill(m);else if(ft(m))m.length!==M&&(m=new Array(M).fill(m[0]));else throw new Error("gradientDifference should be a number or array with length equal to the number of parameters");let E;if(typeof l=="number"){let q=1/l**2;E=()=>q}else if(ft(l))if(l.length<n.x.length){let q=1/l[0]**2;E=()=>q}else E=q=>1/l[q]**2;else throw new Error("weights should be a number or array with length equal to the number of data points");let R;if(t!==void 0){if(typeof t!="number")throw new Error("timeout should be a number");let q=Date.now()+t*1e3;R=()=>Date.now()>q}else R=()=>!1;let I=new Array(n.x.length);for(let q=0;q<c;q++)I[q]=E(q);return{checkTimeout:R,minValues:s,maxValues:o,parameters:S,weightSquare:I,damping:h,dampingStepUp:u,dampingStepDown:a,maxIterations:f,errorTolerance:w,centralDifference:d,gradientDifference:m,improvementThreshold:p}}function $t(n,r,e,t){let s=0;const o=e(r);for(let i=0;i<n.x.length;i++)s+=Math.pow(n.y[i]-o(n.x[i]),2)/t[i];return s}function Ft(n){if(n.__esModule)return n;var r=n.default;if(typeof r=="function"){var e=function t(){return this instanceof t?Reflect.construct(r,arguments,this.constructor):r.apply(this,arguments)};e.prototype=r.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(n).forEach(function(t){var s=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:function(){return n[t]}})}),e}var D={};const xt=Object.prototype.toString;function At(n){const r=xt.call(n);return r.endsWith("Array]")&&!r.includes("Big")}var Ht=Object.freeze({__proto__:null,isAnyArray:At}),te=Ft(Ht);const ee=Object.prototype.toString;function Vt(n){const r=ee.call(n);return r.endsWith("Array]")&&!r.includes("Big")}const se=Object.prototype.toString;function re(n){const r=se.call(n);return r.endsWith("Array]")&&!r.includes("Big")}function oe(n){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!re(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var e=r.fromIndex,t=e===void 0?0:e,s=r.toIndex,o=s===void 0?n.length:s;if(t<0||t>=n.length||!Number.isInteger(t))throw new Error("fromIndex must be a positive integer smaller than length");if(o<=t||o>n.length||!Number.isInteger(o))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var i=n[t],l=t+1;l<o;l++)n[l]>i&&(i=n[l]);return i}const ne=Object.prototype.toString;function ie(n){const r=ne.call(n);return r.endsWith("Array]")&&!r.includes("Big")}function le(n){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!ie(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var e=r.fromIndex,t=e===void 0?0:e,s=r.toIndex,o=s===void 0?n.length:s;if(t<0||t>=n.length||!Number.isInteger(t))throw new Error("fromIndex must be a positive integer smaller than length");if(o<=t||o>n.length||!Number.isInteger(o))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var i=n[t],l=t+1;l<o;l++)n[l]<i&&(i=n[l]);return i}function he(n){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(Vt(n)){if(n.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var e;if(r.output!==void 0){if(!Vt(r.output))throw new TypeError("output option must be an array if specified");e=r.output}else e=new Array(n.length);var t=le(n),s=oe(n);if(t===s)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var o=r.min,i=o===void 0?r.autoMinMax?t:0:o,l=r.max,h=l===void 0?r.autoMinMax?s:1:l;if(i>=h)throw new RangeError("min option must be smaller than max option");for(var u=(h-i)/(s-t),a=0;a<n.length;a++)e[a]=(n[a]-t)*u+i;return e}var ue=Object.freeze({__proto__:null,default:he}),fe=Ft(ue);Object.defineProperty(D,"__esModule",{value:!0});var G=te,Pt=fe;const gt=" ".repeat(2),zt=" ".repeat(4);function ce(){return Ct(this)}function Ct(n,r={}){const{maxRows:e=15,maxColumns:t=10,maxNumSize:s=8,padMinus:o="auto"}=r;return`${n.constructor.name} {
${gt}[
${zt}${ae(n,e,t,s,o)}
${gt}]
${gt}rows: ${n.rows}
${gt}columns: ${n.columns}
}`}function ae(n,r,e,t,s){const{rows:o,columns:i}=n,l=Math.min(o,r),h=Math.min(i,e),u=[];if(s==="auto"){s=!1;t:for(let a=0;a<l;a++)for(let f=0;f<h;f++)if(n.get(a,f)<0){s=!0;break t}}for(let a=0;a<l;a++){let f=[];for(let w=0;w<h;w++)f.push(ge(n.get(a,w),t,s));u.push(`${f.join(" ")}`)}return h!==i&&(u[u.length-1]+=` ... ${i-e} more columns`),l!==o&&u.push(`... ${o-r} more rows`),u.join(`
${zt}`)}function ge(n,r,e){return(n>=0&&e?` ${Ot(n,r-1)}`:Ot(n,r)).padEnd(r)}function Ot(n,r){let e=n.toString();if(e.length<=r)return e;let t=n.toFixed(r);if(t.length>r&&(t=n.toFixed(Math.max(0,r-(t.length-r)))),t.length<=r&&!t.startsWith("0.000")&&!t.startsWith("-0.000"))return t;let s=n.toExponential(r);return s.length>r&&(s=n.toExponential(Math.max(0,r-(s.length-r)))),s.slice(0)}function me(n,r){n.prototype.add=function(t){return typeof t=="number"?this.addS(t):this.addM(t)},n.prototype.addS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)+t);return this},n.prototype.addM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)+t.get(s,o));return this},n.add=function(t,s){return new r(t).add(s)},n.prototype.sub=function(t){return typeof t=="number"?this.subS(t):this.subM(t)},n.prototype.subS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)-t);return this},n.prototype.subM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)-t.get(s,o));return this},n.sub=function(t,s){return new r(t).sub(s)},n.prototype.subtract=n.prototype.sub,n.prototype.subtractS=n.prototype.subS,n.prototype.subtractM=n.prototype.subM,n.subtract=n.sub,n.prototype.mul=function(t){return typeof t=="number"?this.mulS(t):this.mulM(t)},n.prototype.mulS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)*t);return this},n.prototype.mulM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)*t.get(s,o));return this},n.mul=function(t,s){return new r(t).mul(s)},n.prototype.multiply=n.prototype.mul,n.prototype.multiplyS=n.prototype.mulS,n.prototype.multiplyM=n.prototype.mulM,n.multiply=n.mul,n.prototype.div=function(t){return typeof t=="number"?this.divS(t):this.divM(t)},n.prototype.divS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)/t);return this},n.prototype.divM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)/t.get(s,o));return this},n.div=function(t,s){return new r(t).div(s)},n.prototype.divide=n.prototype.div,n.prototype.divideS=n.prototype.divS,n.prototype.divideM=n.prototype.divM,n.divide=n.div,n.prototype.mod=function(t){return typeof t=="number"?this.modS(t):this.modM(t)},n.prototype.modS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)%t);return this},n.prototype.modM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)%t.get(s,o));return this},n.mod=function(t,s){return new r(t).mod(s)},n.prototype.modulus=n.prototype.mod,n.prototype.modulusS=n.prototype.modS,n.prototype.modulusM=n.prototype.modM,n.modulus=n.mod,n.prototype.and=function(t){return typeof t=="number"?this.andS(t):this.andM(t)},n.prototype.andS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)&t);return this},n.prototype.andM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)&t.get(s,o));return this},n.and=function(t,s){return new r(t).and(s)},n.prototype.or=function(t){return typeof t=="number"?this.orS(t):this.orM(t)},n.prototype.orS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)|t);return this},n.prototype.orM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)|t.get(s,o));return this},n.or=function(t,s){return new r(t).or(s)},n.prototype.xor=function(t){return typeof t=="number"?this.xorS(t):this.xorM(t)},n.prototype.xorS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)^t);return this},n.prototype.xorM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)^t.get(s,o));return this},n.xor=function(t,s){return new r(t).xor(s)},n.prototype.leftShift=function(t){return typeof t=="number"?this.leftShiftS(t):this.leftShiftM(t)},n.prototype.leftShiftS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)<<t);return this},n.prototype.leftShiftM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)<<t.get(s,o));return this},n.leftShift=function(t,s){return new r(t).leftShift(s)},n.prototype.signPropagatingRightShift=function(t){return typeof t=="number"?this.signPropagatingRightShiftS(t):this.signPropagatingRightShiftM(t)},n.prototype.signPropagatingRightShiftS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)>>t);return this},n.prototype.signPropagatingRightShiftM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)>>t.get(s,o));return this},n.signPropagatingRightShift=function(t,s){return new r(t).signPropagatingRightShift(s)},n.prototype.rightShift=function(t){return typeof t=="number"?this.rightShiftS(t):this.rightShiftM(t)},n.prototype.rightShiftS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)>>>t);return this},n.prototype.rightShiftM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)>>>t.get(s,o));return this},n.rightShift=function(t,s){return new r(t).rightShift(s)},n.prototype.zeroFillRightShift=n.prototype.rightShift,n.prototype.zeroFillRightShiftS=n.prototype.rightShiftS,n.prototype.zeroFillRightShiftM=n.prototype.rightShiftM,n.zeroFillRightShift=n.rightShift,n.prototype.not=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,~this.get(t,s));return this},n.not=function(t){return new r(t).not()},n.prototype.abs=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.abs(this.get(t,s)));return this},n.abs=function(t){return new r(t).abs()},n.prototype.acos=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.acos(this.get(t,s)));return this},n.acos=function(t){return new r(t).acos()},n.prototype.acosh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.acosh(this.get(t,s)));return this},n.acosh=function(t){return new r(t).acosh()},n.prototype.asin=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.asin(this.get(t,s)));return this},n.asin=function(t){return new r(t).asin()},n.prototype.asinh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.asinh(this.get(t,s)));return this},n.asinh=function(t){return new r(t).asinh()},n.prototype.atan=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.atan(this.get(t,s)));return this},n.atan=function(t){return new r(t).atan()},n.prototype.atanh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.atanh(this.get(t,s)));return this},n.atanh=function(t){return new r(t).atanh()},n.prototype.cbrt=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cbrt(this.get(t,s)));return this},n.cbrt=function(t){return new r(t).cbrt()},n.prototype.ceil=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.ceil(this.get(t,s)));return this},n.ceil=function(t){return new r(t).ceil()},n.prototype.clz32=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.clz32(this.get(t,s)));return this},n.clz32=function(t){return new r(t).clz32()},n.prototype.cos=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cos(this.get(t,s)));return this},n.cos=function(t){return new r(t).cos()},n.prototype.cosh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cosh(this.get(t,s)));return this},n.cosh=function(t){return new r(t).cosh()},n.prototype.exp=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.exp(this.get(t,s)));return this},n.exp=function(t){return new r(t).exp()},n.prototype.expm1=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.expm1(this.get(t,s)));return this},n.expm1=function(t){return new r(t).expm1()},n.prototype.floor=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.floor(this.get(t,s)));return this},n.floor=function(t){return new r(t).floor()},n.prototype.fround=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.fround(this.get(t,s)));return this},n.fround=function(t){return new r(t).fround()},n.prototype.log=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log(this.get(t,s)));return this},n.log=function(t){return new r(t).log()},n.prototype.log1p=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log1p(this.get(t,s)));return this},n.log1p=function(t){return new r(t).log1p()},n.prototype.log10=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log10(this.get(t,s)));return this},n.log10=function(t){return new r(t).log10()},n.prototype.log2=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log2(this.get(t,s)));return this},n.log2=function(t){return new r(t).log2()},n.prototype.round=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.round(this.get(t,s)));return this},n.round=function(t){return new r(t).round()},n.prototype.sign=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sign(this.get(t,s)));return this},n.sign=function(t){return new r(t).sign()},n.prototype.sin=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sin(this.get(t,s)));return this},n.sin=function(t){return new r(t).sin()},n.prototype.sinh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sinh(this.get(t,s)));return this},n.sinh=function(t){return new r(t).sinh()},n.prototype.sqrt=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sqrt(this.get(t,s)));return this},n.sqrt=function(t){return new r(t).sqrt()},n.prototype.tan=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.tan(this.get(t,s)));return this},n.tan=function(t){return new r(t).tan()},n.prototype.tanh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.tanh(this.get(t,s)));return this},n.tanh=function(t){return new r(t).tanh()},n.prototype.trunc=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.trunc(this.get(t,s)));return this},n.trunc=function(t){return new r(t).trunc()},n.pow=function(t,s){return new r(t).pow(s)},n.prototype.pow=function(t){return typeof t=="number"?this.powS(t):this.powM(t)},n.prototype.powS=function(t){for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)**t);return this},n.prototype.powM=function(t){if(t=r.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let o=0;o<this.columns;o++)this.set(s,o,this.get(s,o)**t.get(s,o));return this}}function Z(n,r,e){let t=e?n.rows:n.rows-1;if(r<0||r>t)throw new RangeError("Row index out of range")}function x(n,r,e){let t=e?n.columns:n.columns-1;if(r<0||r>t)throw new RangeError("Column index out of range")}function it(n,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==n.columns)throw new RangeError("vector size must be the same as the number of columns");return r}function lt(n,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==n.rows)throw new RangeError("vector size must be the same as the number of rows");return r}function jt(n,r){if(!G.isAnyArray(r))throw new TypeError("row indices must be an array");for(let e=0;e<r.length;e++)if(r[e]<0||r[e]>=n.rows)throw new RangeError("row indices are out of range")}function vt(n,r){if(!G.isAnyArray(r))throw new TypeError("column indices must be an array");for(let e=0;e<r.length;e++)if(r[e]<0||r[e]>=n.columns)throw new RangeError("column indices are out of range")}function kt(n,r,e,t,s){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(wt("startRow",r),wt("endRow",e),wt("startColumn",t),wt("endColumn",s),r>e||t>s||r<0||r>=n.rows||e<0||e>=n.rows||t<0||t>=n.columns||s<0||s>=n.columns)throw new RangeError("Submatrix indices are out of range")}function mt(n,r=0){let e=[];for(let t=0;t<n;t++)e.push(r);return e}function wt(n,r){if(typeof r!="number")throw new TypeError(`${n} must be a number`)}function ht(n){if(n.isEmpty())throw new Error("Empty matrix has no elements to index")}function we(n){let r=mt(n.rows);for(let e=0;e<n.rows;++e)for(let t=0;t<n.columns;++t)r[e]+=n.get(e,t);return r}function pe(n){let r=mt(n.columns);for(let e=0;e<n.rows;++e)for(let t=0;t<n.columns;++t)r[t]+=n.get(e,t);return r}function de(n){let r=0;for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)r+=n.get(e,t);return r}function ye(n){let r=mt(n.rows,1);for(let e=0;e<n.rows;++e)for(let t=0;t<n.columns;++t)r[e]*=n.get(e,t);return r}function Me(n){let r=mt(n.columns,1);for(let e=0;e<n.rows;++e)for(let t=0;t<n.columns;++t)r[t]*=n.get(e,t);return r}function be(n){let r=1;for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)r*=n.get(e,t);return r}function Se(n,r,e){const t=n.rows,s=n.columns,o=[];for(let i=0;i<t;i++){let l=0,h=0,u=0;for(let a=0;a<s;a++)u=n.get(i,a)-e[i],l+=u,h+=u*u;r?o.push((h-l*l/s)/(s-1)):o.push((h-l*l/s)/s)}return o}function Ee(n,r,e){const t=n.rows,s=n.columns,o=[];for(let i=0;i<s;i++){let l=0,h=0,u=0;for(let a=0;a<t;a++)u=n.get(a,i)-e[i],l+=u,h+=u*u;r?o.push((h-l*l/t)/(t-1)):o.push((h-l*l/t)/t)}return o}function je(n,r,e){const t=n.rows,s=n.columns,o=t*s;let i=0,l=0,h=0;for(let u=0;u<t;u++)for(let a=0;a<s;a++)h=n.get(u,a)-e,i+=h,l+=h*h;return r?(l-i*i/o)/(o-1):(l-i*i/o)/o}function ve(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)-r[e])}function ke(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)-r[t])}function Re(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)-r)}function Ie(n){const r=[];for(let e=0;e<n.rows;e++){let t=0;for(let s=0;s<n.columns;s++)t+=n.get(e,s)**2/(n.columns-1);r.push(Math.sqrt(t))}return r}function Te(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)/r[e])}function Ne(n){const r=[];for(let e=0;e<n.columns;e++){let t=0;for(let s=0;s<n.rows;s++)t+=n.get(s,e)**2/(n.rows-1);r.push(Math.sqrt(t))}return r}function qe(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)/r[t])}function De(n){const r=n.size-1;let e=0;for(let t=0;t<n.columns;t++)for(let s=0;s<n.rows;s++)e+=n.get(s,t)**2/r;return Math.sqrt(e)}function $e(n,r){for(let e=0;e<n.rows;e++)for(let t=0;t<n.columns;t++)n.set(e,t,n.get(e,t)/r)}class N{static from1DArray(r,e,t){if(r*e!==t.length)throw new RangeError("data length does not match given dimensions");let o=new j(r,e);for(let i=0;i<r;i++)for(let l=0;l<e;l++)o.set(i,l,t[i*e+l]);return o}static rowVector(r){let e=new j(1,r.length);for(let t=0;t<r.length;t++)e.set(0,t,r[t]);return e}static columnVector(r){let e=new j(r.length,1);for(let t=0;t<r.length;t++)e.set(t,0,r[t]);return e}static zeros(r,e){return new j(r,e)}static ones(r,e){return new j(r,e).fill(1)}static rand(r,e,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{random:s=Math.random}=t;let o=new j(r,e);for(let i=0;i<r;i++)for(let l=0;l<e;l++)o.set(i,l,s());return o}static randInt(r,e,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:o=1e3,random:i=Math.random}=t;if(!Number.isInteger(s))throw new TypeError("min must be an integer");if(!Number.isInteger(o))throw new TypeError("max must be an integer");if(s>=o)throw new RangeError("min must be smaller than max");let l=o-s,h=new j(r,e);for(let u=0;u<r;u++)for(let a=0;a<e;a++){let f=s+Math.round(i()*l);h.set(u,a,f)}return h}static eye(r,e,t){e===void 0&&(e=r),t===void 0&&(t=1);let s=Math.min(r,e),o=this.zeros(r,e);for(let i=0;i<s;i++)o.set(i,i,t);return o}static diag(r,e,t){let s=r.length;e===void 0&&(e=s),t===void 0&&(t=e);let o=Math.min(s,e,t),i=this.zeros(e,t);for(let l=0;l<o;l++)i.set(l,l,r[l]);return i}static min(r,e){r=this.checkMatrix(r),e=this.checkMatrix(e);let t=r.rows,s=r.columns,o=new j(t,s);for(let i=0;i<t;i++)for(let l=0;l<s;l++)o.set(i,l,Math.min(r.get(i,l),e.get(i,l)));return o}static max(r,e){r=this.checkMatrix(r),e=this.checkMatrix(e);let t=r.rows,s=r.columns,o=new this(t,s);for(let i=0;i<t;i++)for(let l=0;l<s;l++)o.set(i,l,Math.max(r.get(i,l),e.get(i,l)));return o}static checkMatrix(r){return N.isMatrix(r)?r:new j(r)}static isMatrix(r){return r!=null&&r.klass==="Matrix"}get size(){return this.rows*this.columns}apply(r){if(typeof r!="function")throw new TypeError("callback must be a function");for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)r.call(this,e,t);return this}to1DArray(){let r=[];for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)r.push(this.get(e,t));return r}to2DArray(){let r=[];for(let e=0;e<this.rows;e++){r.push([]);for(let t=0;t<this.columns;t++)r[e].push(this.get(e,t))}return r}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let r=0;r<this.rows;r++)for(let e=0;e<=r;e++)if(this.get(r,e)!==this.get(e,r))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let r=0;r<this.rows;r++)if(this.get(r,r)!==0)return!1;return!0}isEchelonForm(){let r=0,e=0,t=-1,s=!0,o=!1;for(;r<this.rows&&s;){for(e=0,o=!1;e<this.columns&&o===!1;)this.get(r,e)===0?e++:this.get(r,e)===1&&e>t?(o=!0,t=e):(s=!1,o=!0);r++}return s}isReducedEchelonForm(){let r=0,e=0,t=-1,s=!0,o=!1;for(;r<this.rows&&s;){for(e=0,o=!1;e<this.columns&&o===!1;)this.get(r,e)===0?e++:this.get(r,e)===1&&e>t?(o=!0,t=e):(s=!1,o=!0);for(let i=e+1;i<this.rows;i++)this.get(r,i)!==0&&(s=!1);r++}return s}echelonForm(){let r=this.clone(),e=0,t=0;for(;e<r.rows&&t<r.columns;){let s=e;for(let o=e;o<r.rows;o++)r.get(o,t)>r.get(s,t)&&(s=o);if(r.get(s,t)===0)t++;else{r.swapRows(e,s);let o=r.get(e,t);for(let i=t;i<r.columns;i++)r.set(e,i,r.get(e,i)/o);for(let i=e+1;i<r.rows;i++){let l=r.get(i,t)/r.get(e,t);r.set(i,t,0);for(let h=t+1;h<r.columns;h++)r.set(i,h,r.get(i,h)-r.get(e,h)*l)}e++,t++}}return r}reducedEchelonForm(){let r=this.echelonForm(),e=r.columns,t=r.rows,s=t-1;for(;s>=0;)if(r.maxRow(s)===0)s--;else{let o=0,i=!1;for(;o<t&&i===!1;)r.get(s,o)===1?i=!0:o++;for(let l=0;l<s;l++){let h=r.get(l,o);for(let u=o;u<e;u++){let a=r.get(l,u)-h*r.get(s,u);r.set(l,u,a)}}s--}return r}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{rows:e=1,columns:t=1}=r;if(!Number.isInteger(e)||e<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(t)||t<=0)throw new TypeError("columns must be a positive integer");let s=new j(this.rows*e,this.columns*t);for(let o=0;o<e;o++)for(let i=0;i<t;i++)s.setSubMatrix(this,this.rows*o,this.columns*i);return s}fill(r){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,r);return this}neg(){return this.mulS(-1)}getRow(r){Z(this,r);let e=[];for(let t=0;t<this.columns;t++)e.push(this.get(r,t));return e}getRowVector(r){return j.rowVector(this.getRow(r))}setRow(r,e){Z(this,r),e=it(this,e);for(let t=0;t<this.columns;t++)this.set(r,t,e[t]);return this}swapRows(r,e){Z(this,r),Z(this,e);for(let t=0;t<this.columns;t++){let s=this.get(r,t);this.set(r,t,this.get(e,t)),this.set(e,t,s)}return this}getColumn(r){x(this,r);let e=[];for(let t=0;t<this.rows;t++)e.push(this.get(t,r));return e}getColumnVector(r){return j.columnVector(this.getColumn(r))}setColumn(r,e){x(this,r),e=lt(this,e);for(let t=0;t<this.rows;t++)this.set(t,r,e[t]);return this}swapColumns(r,e){x(this,r),x(this,e);for(let t=0;t<this.rows;t++){let s=this.get(t,r);this.set(t,r,this.get(t,e)),this.set(t,e,s)}return this}addRowVector(r){r=it(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)+r[t]);return this}subRowVector(r){r=it(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)-r[t]);return this}mulRowVector(r){r=it(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)*r[t]);return this}divRowVector(r){r=it(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)/r[t]);return this}addColumnVector(r){r=lt(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)+r[e]);return this}subColumnVector(r){r=lt(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)-r[e]);return this}mulColumnVector(r){r=lt(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)*r[e]);return this}divColumnVector(r){r=lt(this,r);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)/r[e]);return this}mulRow(r,e){Z(this,r);for(let t=0;t<this.columns;t++)this.set(r,t,this.get(r,t)*e);return this}mulColumn(r,e){x(this,r);for(let t=0;t<this.rows;t++)this.set(t,r,this.get(t,r)*e);return this}max(r){if(this.isEmpty())return NaN;switch(r){case"row":{const e=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e[t]&&(e[t]=this.get(t,s));return e}case"column":{const e=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e[s]&&(e[s]=this.get(t,s));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e&&(e=this.get(t,s));return e}default:throw new Error(`invalid option: ${r}`)}}maxIndex(){ht(this);let r=this.get(0,0),e=[0,0];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>r&&(r=this.get(t,s),e[0]=t,e[1]=s);return e}min(r){if(this.isEmpty())return NaN;switch(r){case"row":{const e=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e[t]&&(e[t]=this.get(t,s));return e}case"column":{const e=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e[s]&&(e[s]=this.get(t,s));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e&&(e=this.get(t,s));return e}default:throw new Error(`invalid option: ${r}`)}}minIndex(){ht(this);let r=this.get(0,0),e=[0,0];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<r&&(r=this.get(t,s),e[0]=t,e[1]=s);return e}maxRow(r){if(Z(this,r),this.isEmpty())return NaN;let e=this.get(r,0);for(let t=1;t<this.columns;t++)this.get(r,t)>e&&(e=this.get(r,t));return e}maxRowIndex(r){Z(this,r),ht(this);let e=this.get(r,0),t=[r,0];for(let s=1;s<this.columns;s++)this.get(r,s)>e&&(e=this.get(r,s),t[1]=s);return t}minRow(r){if(Z(this,r),this.isEmpty())return NaN;let e=this.get(r,0);for(let t=1;t<this.columns;t++)this.get(r,t)<e&&(e=this.get(r,t));return e}minRowIndex(r){Z(this,r),ht(this);let e=this.get(r,0),t=[r,0];for(let s=1;s<this.columns;s++)this.get(r,s)<e&&(e=this.get(r,s),t[1]=s);return t}maxColumn(r){if(x(this,r),this.isEmpty())return NaN;let e=this.get(0,r);for(let t=1;t<this.rows;t++)this.get(t,r)>e&&(e=this.get(t,r));return e}maxColumnIndex(r){x(this,r),ht(this);let e=this.get(0,r),t=[0,r];for(let s=1;s<this.rows;s++)this.get(s,r)>e&&(e=this.get(s,r),t[0]=s);return t}minColumn(r){if(x(this,r),this.isEmpty())return NaN;let e=this.get(0,r);for(let t=1;t<this.rows;t++)this.get(t,r)<e&&(e=this.get(t,r));return e}minColumnIndex(r){x(this,r),ht(this);let e=this.get(0,r),t=[0,r];for(let s=1;s<this.rows;s++)this.get(s,r)<e&&(e=this.get(s,r),t[0]=s);return t}diag(){let r=Math.min(this.rows,this.columns),e=[];for(let t=0;t<r;t++)e.push(this.get(t,t));return e}norm(r="frobenius"){switch(r){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${r}`)}}cumulativeSum(){let r=0;for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)r+=this.get(e,t),this.set(e,t,r);return this}dot(r){N.isMatrix(r)&&(r=r.to1DArray());let e=this.to1DArray();if(e.length!==r.length)throw new RangeError("vectors do not have the same size");let t=0;for(let s=0;s<e.length;s++)t+=e[s]*r[s];return t}mmul(r){r=j.checkMatrix(r);let e=this.rows,t=this.columns,s=r.columns,o=new j(e,s),i=new Float64Array(t);for(let l=0;l<s;l++){for(let h=0;h<t;h++)i[h]=r.get(h,l);for(let h=0;h<e;h++){let u=0;for(let a=0;a<t;a++)u+=this.get(h,a)*i[a];o.set(h,l,u)}}return o}mpow(r){if(!this.isSquare())throw new RangeError("Matrix must be square");if(!Number.isInteger(r)||r<0)throw new RangeError("Exponent must be a non-negative integer");let e=j.eye(this.rows),t=this;for(let s=r;s>=1;s/=2)s&1&&(e=e.mmul(t)),t=t.mmul(t);return e}strassen2x2(r){r=j.checkMatrix(r);let e=new j(2,2);const t=this.get(0,0),s=r.get(0,0),o=this.get(0,1),i=r.get(0,1),l=this.get(1,0),h=r.get(1,0),u=this.get(1,1),a=r.get(1,1),f=(t+u)*(s+a),w=(l+u)*s,d=t*(i-a),m=u*(h-s),p=(t+o)*a,S=(l-t)*(s+i),c=(o-u)*(h+a),M=f+m-p+c,E=d+p,R=w+m,I=f-w+d+S;return e.set(0,0,M),e.set(0,1,E),e.set(1,0,R),e.set(1,1,I),e}strassen3x3(r){r=j.checkMatrix(r);let e=new j(3,3);const t=this.get(0,0),s=this.get(0,1),o=this.get(0,2),i=this.get(1,0),l=this.get(1,1),h=this.get(1,2),u=this.get(2,0),a=this.get(2,1),f=this.get(2,2),w=r.get(0,0),d=r.get(0,1),m=r.get(0,2),p=r.get(1,0),S=r.get(1,1),c=r.get(1,2),M=r.get(2,0),E=r.get(2,1),R=r.get(2,2),I=(t+s+o-i-l-a-f)*S,q=(t-i)*(-d+S),k=l*(-w+d+p-S-c-M+R),T=(-t+i+l)*(w-d+S),V=(i+l)*(-w+d),g=t*w,y=(-t+u+a)*(w-m+c),v=(-t+u)*(m-c),b=(u+a)*(-w+m),O=(t+s+o-l-h-u-a)*c,F=a*(-w+m+p-S-c-M+E),z=(-o+a+f)*(S+M-E),L=(o-f)*(S-E),_=o*M,A=(a+f)*(-M+E),U=(-o+l+h)*(c+M-R),tt=(o-h)*(c-R),rt=(l+h)*(-M+R),$=s*p,Q=h*E,X=i*m,K=u*d,W=f*R,is=g+_+$,ls=I+T+V+g+z+_+A,hs=g+y+b+O+_+U+rt,us=q+k+T+g+_+U+tt,fs=q+T+V+g+Q,cs=_+U+tt+rt+X,as=g+y+v+F+z+L+_,gs=z+L+_+A+K,ms=g+y+v+b+W;return e.set(0,0,is),e.set(0,1,ls),e.set(0,2,hs),e.set(1,0,us),e.set(1,1,fs),e.set(1,2,cs),e.set(2,0,as),e.set(2,1,gs),e.set(2,2,ms),e}mmulStrassen(r){r=j.checkMatrix(r);let e=this.clone(),t=e.rows,s=e.columns,o=r.rows,i=r.columns;s!==o&&console.warn(`Multiplying ${t} x ${s} and ${o} x ${i} matrix: dimensions do not match.`);function l(f,w,d){let m=f.rows,p=f.columns;if(m===w&&p===d)return f;{let S=N.zeros(w,d);return S=S.setSubMatrix(f,0,0),S}}let h=Math.max(t,o),u=Math.max(s,i);e=l(e,h,u),r=l(r,h,u);function a(f,w,d,m){if(d<=512||m<=512)return f.mmul(w);d%2===1&&m%2===1?(f=l(f,d+1,m+1),w=l(w,d+1,m+1)):d%2===1?(f=l(f,d+1,m),w=l(w,d+1,m)):m%2===1&&(f=l(f,d,m+1),w=l(w,d,m+1));let p=parseInt(f.rows/2,10),S=parseInt(f.columns/2,10),c=f.subMatrix(0,p-1,0,S-1),M=w.subMatrix(0,p-1,0,S-1),E=f.subMatrix(0,p-1,S,f.columns-1),R=w.subMatrix(0,p-1,S,w.columns-1),I=f.subMatrix(p,f.rows-1,0,S-1),q=w.subMatrix(p,w.rows-1,0,S-1),k=f.subMatrix(p,f.rows-1,S,f.columns-1),T=w.subMatrix(p,w.rows-1,S,w.columns-1),V=a(N.add(c,k),N.add(M,T),p,S),g=a(N.add(I,k),M,p,S),y=a(c,N.sub(R,T),p,S),v=a(k,N.sub(q,M),p,S),b=a(N.add(c,E),T,p,S),O=a(N.sub(I,c),N.add(M,R),p,S),F=a(N.sub(E,k),N.add(q,T),p,S),z=N.add(V,v);z.sub(b),z.add(F);let L=N.add(y,b),_=N.add(g,v),A=N.sub(V,g);A.add(y),A.add(O);let U=N.zeros(2*z.rows,2*z.columns);return U=U.setSubMatrix(z,0,0),U=U.setSubMatrix(L,z.rows,0),U=U.setSubMatrix(_,0,z.columns),U=U.setSubMatrix(A,z.rows,z.columns),U.subMatrix(0,d-1,0,m-1)}return a(e,r,h,u)}scaleRows(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:e=0,max:t=1}=r;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(e>=t)throw new RangeError("min must be smaller than max");let s=new j(this.rows,this.columns);for(let o=0;o<this.rows;o++){const i=this.getRow(o);i.length>0&&Pt(i,{min:e,max:t,output:i}),s.setRow(o,i)}return s}scaleColumns(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:e=0,max:t=1}=r;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(e>=t)throw new RangeError("min must be smaller than max");let s=new j(this.rows,this.columns);for(let o=0;o<this.columns;o++){const i=this.getColumn(o);i.length&&Pt(i,{min:e,max:t,output:i}),s.setColumn(o,i)}return s}flipRows(){const r=Math.ceil(this.columns/2);for(let e=0;e<this.rows;e++)for(let t=0;t<r;t++){let s=this.get(e,t),o=this.get(e,this.columns-1-t);this.set(e,t,o),this.set(e,this.columns-1-t,s)}return this}flipColumns(){const r=Math.ceil(this.rows/2);for(let e=0;e<this.columns;e++)for(let t=0;t<r;t++){let s=this.get(t,e),o=this.get(this.rows-1-t,e);this.set(t,e,o),this.set(this.rows-1-t,e,s)}return this}kroneckerProduct(r){r=j.checkMatrix(r);let e=this.rows,t=this.columns,s=r.rows,o=r.columns,i=new j(e*s,t*o);for(let l=0;l<e;l++)for(let h=0;h<t;h++)for(let u=0;u<s;u++)for(let a=0;a<o;a++)i.set(s*l+u,o*h+a,this.get(l,h)*r.get(u,a));return i}kroneckerSum(r){if(r=j.checkMatrix(r),!this.isSquare()||!r.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let e=this.rows,t=r.rows,s=this.kroneckerProduct(j.eye(t,t)),o=j.eye(e,e).kroneckerProduct(r);return s.add(o)}transpose(){let r=new j(this.columns,this.rows);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)r.set(t,e,this.get(e,t));return r}sortRows(r=Lt){for(let e=0;e<this.rows;e++)this.setRow(e,this.getRow(e).sort(r));return this}sortColumns(r=Lt){for(let e=0;e<this.columns;e++)this.setColumn(e,this.getColumn(e).sort(r));return this}subMatrix(r,e,t,s){kt(this,r,e,t,s);let o=new j(e-r+1,s-t+1);for(let i=r;i<=e;i++)for(let l=t;l<=s;l++)o.set(i-r,l-t,this.get(i,l));return o}subMatrixRow(r,e,t){if(e===void 0&&(e=0),t===void 0&&(t=this.columns-1),e>t||e<0||e>=this.columns||t<0||t>=this.columns)throw new RangeError("Argument out of range");let s=new j(r.length,t-e+1);for(let o=0;o<r.length;o++)for(let i=e;i<=t;i++){if(r[o]<0||r[o]>=this.rows)throw new RangeError(`Row index out of range: ${r[o]}`);s.set(o,i-e,this.get(r[o],i))}return s}subMatrixColumn(r,e,t){if(e===void 0&&(e=0),t===void 0&&(t=this.rows-1),e>t||e<0||e>=this.rows||t<0||t>=this.rows)throw new RangeError("Argument out of range");let s=new j(t-e+1,r.length);for(let o=0;o<r.length;o++)for(let i=e;i<=t;i++){if(r[o]<0||r[o]>=this.columns)throw new RangeError(`Column index out of range: ${r[o]}`);s.set(i-e,o,this.get(i,r[o]))}return s}setSubMatrix(r,e,t){if(r=j.checkMatrix(r),r.isEmpty())return this;let s=e+r.rows-1,o=t+r.columns-1;kt(this,e,s,t,o);for(let i=0;i<r.rows;i++)for(let l=0;l<r.columns;l++)this.set(e+i,t+l,r.get(i,l));return this}selection(r,e){jt(this,r),vt(this,e);let t=new j(r.length,e.length);for(let s=0;s<r.length;s++){let o=r[s];for(let i=0;i<e.length;i++){let l=e[i];t.set(s,i,this.get(o,l))}}return t}trace(){let r=Math.min(this.rows,this.columns),e=0;for(let t=0;t<r;t++)e+=this.get(t,t);return e}clone(){return this.constructor.copy(this,new j(this.rows,this.columns))}static copy(r,e){for(const[t,s,o]of r.entries())e.set(t,s,o);return e}sum(r){switch(r){case"row":return we(this);case"column":return pe(this);case void 0:return de(this);default:throw new Error(`invalid option: ${r}`)}}product(r){switch(r){case"row":return ye(this);case"column":return Me(this);case void 0:return be(this);default:throw new Error(`invalid option: ${r}`)}}mean(r){const e=this.sum(r);switch(r){case"row":{for(let t=0;t<this.rows;t++)e[t]/=this.columns;return e}case"column":{for(let t=0;t<this.columns;t++)e[t]/=this.rows;return e}case void 0:return e/this.size;default:throw new Error(`invalid option: ${r}`)}}variance(r,e={}){if(typeof r=="object"&&(e=r,r=void 0),typeof e!="object")throw new TypeError("options must be an object");const{unbiased:t=!0,mean:s=this.mean(r)}=e;if(typeof t!="boolean")throw new TypeError("unbiased must be a boolean");switch(r){case"row":{if(!G.isAnyArray(s))throw new TypeError("mean must be an array");return Se(this,t,s)}case"column":{if(!G.isAnyArray(s))throw new TypeError("mean must be an array");return Ee(this,t,s)}case void 0:{if(typeof s!="number")throw new TypeError("mean must be a number");return je(this,t,s)}default:throw new Error(`invalid option: ${r}`)}}standardDeviation(r,e){typeof r=="object"&&(e=r,r=void 0);const t=this.variance(r,e);if(r===void 0)return Math.sqrt(t);for(let s=0;s<t.length;s++)t[s]=Math.sqrt(t[s]);return t}center(r,e={}){if(typeof r=="object"&&(e=r,r=void 0),typeof e!="object")throw new TypeError("options must be an object");const{center:t=this.mean(r)}=e;switch(r){case"row":{if(!G.isAnyArray(t))throw new TypeError("center must be an array");return ve(this,t),this}case"column":{if(!G.isAnyArray(t))throw new TypeError("center must be an array");return ke(this,t),this}case void 0:{if(typeof t!="number")throw new TypeError("center must be a number");return Re(this,t),this}default:throw new Error(`invalid option: ${r}`)}}scale(r,e={}){if(typeof r=="object"&&(e=r,r=void 0),typeof e!="object")throw new TypeError("options must be an object");let t=e.scale;switch(r){case"row":{if(t===void 0)t=Ie(this);else if(!G.isAnyArray(t))throw new TypeError("scale must be an array");return Te(this,t),this}case"column":{if(t===void 0)t=Ne(this);else if(!G.isAnyArray(t))throw new TypeError("scale must be an array");return qe(this,t),this}case void 0:{if(t===void 0)t=De(this);else if(typeof t!="number")throw new TypeError("scale must be a number");return $e(this,t),this}default:throw new Error(`invalid option: ${r}`)}}toString(r){return Ct(this,r)}[Symbol.iterator](){return this.entries()}*entries(){for(let r=0;r<this.rows;r++)for(let e=0;e<this.columns;e++)yield[r,e,this.get(r,e)]}*values(){for(let r=0;r<this.rows;r++)for(let e=0;e<this.columns;e++)yield this.get(r,e)}}N.prototype.klass="Matrix",typeof Symbol<"u"&&(N.prototype[Symbol.for("nodejs.util.inspect.custom")]=ce);function Lt(n,r){return n-r}function Fe(n){return n.every(r=>typeof r=="number")}N.random=N.rand,N.randomInt=N.randInt,N.diagonal=N.diag,N.prototype.diagonal=N.prototype.diag,N.identity=N.eye,N.prototype.negate=N.prototype.neg,N.prototype.tensorProduct=N.prototype.kroneckerProduct;let j=(nt=class extends N{constructor(e,t){super();Nt(this,ct);Xt(this,"data");if(nt.isMatrix(e))qt(this,ct,Dt).call(this,e.rows,e.columns),nt.copy(e,this);else if(Number.isInteger(e)&&e>=0)qt(this,ct,Dt).call(this,e,t);else if(G.isAnyArray(e)){const s=e;if(e=s.length,t=e?s[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let o=0;o<e;o++){if(s[o].length!==t)throw new RangeError("Inconsistent array dimensions");if(!Fe(s[o]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(s[o]))}this.rows=e,this.columns=t}else throw new TypeError("First argument must be a positive number or an array")}set(e,t,s){return this.data[e][t]=s,this}get(e,t){return this.data[e][t]}removeRow(e){return Z(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,t){return t===void 0&&(t=e,e=this.rows),Z(this,e,!0),t=Float64Array.from(it(this,t)),this.data.splice(e,0,t),this.rows+=1,this}removeColumn(e){x(this,e);for(let t=0;t<this.rows;t++){const s=new Float64Array(this.columns-1);for(let o=0;o<e;o++)s[o]=this.data[t][o];for(let o=e+1;o<this.columns;o++)s[o-1]=this.data[t][o];this.data[t]=s}return this.columns-=1,this}addColumn(e,t){typeof t>"u"&&(t=e,e=this.columns),x(this,e,!0),t=lt(this,t);for(let s=0;s<this.rows;s++){const o=new Float64Array(this.columns+1);let i=0;for(;i<e;i++)o[i]=this.data[s][i];for(o[i++]=t[s];i<this.columns+1;i++)o[i]=this.data[s][i-1];this.data[s]=o}return this.columns+=1,this}},ct=new WeakSet,Dt=function(e,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let s=0;s<e;s++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");this.rows=e,this.columns=t},nt);me(N,j);const St=class St extends N{constructor(e){super();Nt(this,Y);if(j.isMatrix(e)){if(!e.isSymmetric())throw new TypeError("not symmetric data");Et(this,Y,j.copy(e,new j(e.rows,e.rows)))}else if(Number.isInteger(e)&&e>=0)Et(this,Y,new j(e,e));else if(Et(this,Y,new j(e)),!this.isSymmetric())throw new TypeError("not symmetric data")}get size(){return H(this,Y).size}get rows(){return H(this,Y).rows}get columns(){return H(this,Y).columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(e){return j.isMatrix(e)&&e.klassType==="SymmetricMatrix"}static zeros(e){return new this(e)}static ones(e){return new this(e).fill(1)}clone(){const e=new St(this.diagonalSize);for(const[t,s,o]of this.upperRightEntries())e.set(t,s,o);return e}toMatrix(){return new j(this)}get(e,t){return H(this,Y).get(e,t)}set(e,t,s){return H(this,Y).set(e,t,s),H(this,Y).set(t,e,s),this}removeCross(e){return H(this,Y).removeRow(e),H(this,Y).removeColumn(e),this}addCross(e,t){t===void 0&&(t=e,e=this.diagonalSize);const s=t.slice();return s.splice(e,1),H(this,Y).addRow(e,s),H(this,Y).addColumn(e,t),this}applyMask(e){if(e.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");const t=[];for(const[s,o]of e.entries())o||t.push(s);t.reverse();for(const s of t)this.removeCross(s);return this}toCompact(){const{diagonalSize:e}=this,t=new Array(e*(e+1)/2);for(let s=0,o=0,i=0;i<t.length;i++)t[i]=this.get(o,s),++s>=e&&(s=++o);return t}static fromCompact(e){const t=e.length,s=(Math.sqrt(8*t+1)-1)/2;if(!Number.isInteger(s))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(e)}`);const o=new St(s);for(let i=0,l=0,h=0;h<t;h++)o.set(i,l,e[h]),++i>=s&&(i=++l);return o}*upperRightEntries(){for(let e=0,t=0;e<this.diagonalSize;void 0){const s=this.get(e,t);yield[e,t,s],++t>=this.diagonalSize&&(t=++e)}}*upperRightValues(){for(let e=0,t=0;e<this.diagonalSize;void 0)yield this.get(e,t),++t>=this.diagonalSize&&(t=++e)}};Y=new WeakMap;let ot=St;ot.prototype.klassType="SymmetricMatrix";class pt extends ot{static isDistanceMatrix(r){return ot.isSymmetricMatrix(r)&&r.klassSubType==="DistanceMatrix"}constructor(r){if(super(r),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(r,e,t){return r===e&&(t=0),super.set(r,e,t)}addCross(r,e){return e===void 0&&(e=r,r=this.diagonalSize),e=e.slice(),e[r]=0,super.addCross(r,e)}toSymmetricMatrix(){return new ot(this)}clone(){const r=new pt(this.diagonalSize);for(const[e,t,s]of this.upperRightEntries())e!==t&&r.set(e,t,s);return r}toCompact(){const{diagonalSize:r}=this,e=(r-1)*r/2,t=new Array(e);for(let s=1,o=0,i=0;i<t.length;i++)t[i]=this.get(o,s),++s>=r&&(s=++o+1);return t}static fromCompact(r){const e=r.length;if(e===0)return new this(0);const t=(Math.sqrt(8*e+1)+1)/2;if(!Number.isInteger(t))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(r)}`);const s=new this(t);for(let o=1,i=0,l=0;l<e;l++)s.set(o,i,r[l]),++o>=t&&(o=++i+1);return s}}pt.prototype.klassSubType="DistanceMatrix";class et extends N{constructor(r,e,t){super(),this.matrix=r,this.rows=e,this.columns=t}}class Ve extends et{constructor(r,e){x(r,e),super(r,r.rows,1),this.column=e}set(r,e,t){return this.matrix.set(r,this.column,t),this}get(r){return this.matrix.get(r,this.column)}}class Pe extends et{constructor(r,e){vt(r,e),super(r,r.rows,e.length),this.columnIndices=e}set(r,e,t){return this.matrix.set(r,this.columnIndices[e],t),this}get(r,e){return this.matrix.get(r,this.columnIndices[e])}}class ze extends et{constructor(r){super(r,r.rows,r.columns)}set(r,e,t){return this.matrix.set(r,this.columns-e-1,t),this}get(r,e){return this.matrix.get(r,this.columns-e-1)}}class Ce extends et{constructor(r){super(r,r.rows,r.columns)}set(r,e,t){return this.matrix.set(this.rows-r-1,e,t),this}get(r,e){return this.matrix.get(this.rows-r-1,e)}}class Oe extends et{constructor(r,e){Z(r,e),super(r,1,r.columns),this.row=e}set(r,e,t){return this.matrix.set(this.row,e,t),this}get(r,e){return this.matrix.get(this.row,e)}}class Le extends et{constructor(r,e){jt(r,e),super(r,e.length,r.columns),this.rowIndices=e}set(r,e,t){return this.matrix.set(this.rowIndices[r],e,t),this}get(r,e){return this.matrix.get(this.rowIndices[r],e)}}class dt extends et{constructor(r,e,t){jt(r,e),vt(r,t),super(r,e.length,t.length),this.rowIndices=e,this.columnIndices=t}set(r,e,t){return this.matrix.set(this.rowIndices[r],this.columnIndices[e],t),this}get(r,e){return this.matrix.get(this.rowIndices[r],this.columnIndices[e])}}class Be extends et{constructor(r,e,t,s,o){kt(r,e,t,s,o),super(r,t-e+1,o-s+1),this.startRow=e,this.startColumn=s}set(r,e,t){return this.matrix.set(this.startRow+r,this.startColumn+e,t),this}get(r,e){return this.matrix.get(this.startRow+r,this.startColumn+e)}}class Ue extends et{constructor(r){super(r,r.columns,r.rows)}set(r,e,t){return this.matrix.set(e,r,t),this}get(r,e){return this.matrix.get(e,r)}}class Bt extends N{constructor(r,e={}){const{rows:t=1}=e;if(r.length%t!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=t,this.columns=r.length/t,this.data=r}set(r,e,t){let s=this._calculateIndex(r,e);return this.data[s]=t,this}get(r,e){let t=this._calculateIndex(r,e);return this.data[t]}_calculateIndex(r,e){return r*this.columns+e}}class J extends N{constructor(r){super(),this.data=r,this.rows=r.length,this.columns=r[0].length}set(r,e,t){return this.data[r][e]=t,this}get(r,e){return this.data[r][e]}}function We(n,r){if(G.isAnyArray(n))return n[0]&&G.isAnyArray(n[0])?new J(n):new Bt(n,r);throw new Error("the argument is not an array")}class yt{constructor(r){r=J.checkMatrix(r);let e=r.clone(),t=e.rows,s=e.columns,o=new Float64Array(t),i=1,l,h,u,a,f,w,d,m,p;for(l=0;l<t;l++)o[l]=l;for(m=new Float64Array(t),h=0;h<s;h++){for(l=0;l<t;l++)m[l]=e.get(l,h);for(l=0;l<t;l++){for(p=Math.min(l,h),f=0,u=0;u<p;u++)f+=e.get(l,u)*m[u];m[l]-=f,e.set(l,h,m[l])}for(a=h,l=h+1;l<t;l++)Math.abs(m[l])>Math.abs(m[a])&&(a=l);if(a!==h){for(u=0;u<s;u++)w=e.get(a,u),e.set(a,u,e.get(h,u)),e.set(h,u,w);d=o[a],o[a]=o[h],o[h]=d,i=-i}if(h<t&&e.get(h,h)!==0)for(l=h+1;l<t;l++)e.set(l,h,e.get(l,h)/e.get(h,h))}this.LU=e,this.pivotVector=o,this.pivotSign=i}isSingular(){let r=this.LU,e=r.columns;for(let t=0;t<e;t++)if(r.get(t,t)===0)return!0;return!1}solve(r){r=j.checkMatrix(r);let e=this.LU;if(e.rows!==r.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let s=r.columns,o=r.subMatrixRow(this.pivotVector,0,s-1),i=e.columns,l,h,u;for(u=0;u<i;u++)for(l=u+1;l<i;l++)for(h=0;h<s;h++)o.set(l,h,o.get(l,h)-o.get(u,h)*e.get(l,u));for(u=i-1;u>=0;u--){for(h=0;h<s;h++)o.set(u,h,o.get(u,h)/e.get(u,u));for(l=0;l<u;l++)for(h=0;h<s;h++)o.set(l,h,o.get(l,h)-o.get(u,h)*e.get(l,u))}return o}get determinant(){let r=this.LU;if(!r.isSquare())throw new Error("Matrix must be square");let e=this.pivotSign,t=r.columns;for(let s=0;s<t;s++)e*=r.get(s,s);return e}get lowerTriangularMatrix(){let r=this.LU,e=r.rows,t=r.columns,s=new j(e,t);for(let o=0;o<e;o++)for(let i=0;i<t;i++)o>i?s.set(o,i,r.get(o,i)):o===i?s.set(o,i,1):s.set(o,i,0);return s}get upperTriangularMatrix(){let r=this.LU,e=r.rows,t=r.columns,s=new j(e,t);for(let o=0;o<e;o++)for(let i=0;i<t;i++)o<=i?s.set(o,i,r.get(o,i)):s.set(o,i,0);return s}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function st(n,r){let e=0;return Math.abs(n)>Math.abs(r)?(e=r/n,Math.abs(n)*Math.sqrt(1+e*e)):r!==0?(e=n/r,Math.abs(r)*Math.sqrt(1+e*e)):0}class Rt{constructor(r){r=J.checkMatrix(r);let e=r.clone(),t=r.rows,s=r.columns,o=new Float64Array(s),i,l,h,u;for(h=0;h<s;h++){let a=0;for(i=h;i<t;i++)a=st(a,e.get(i,h));if(a!==0){for(e.get(h,h)<0&&(a=-a),i=h;i<t;i++)e.set(i,h,e.get(i,h)/a);for(e.set(h,h,e.get(h,h)+1),l=h+1;l<s;l++){for(u=0,i=h;i<t;i++)u+=e.get(i,h)*e.get(i,l);for(u=-u/e.get(h,h),i=h;i<t;i++)e.set(i,l,e.get(i,l)+u*e.get(i,h))}}o[h]=-a}this.QR=e,this.Rdiag=o}solve(r){r=j.checkMatrix(r);let e=this.QR,t=e.rows;if(r.rows!==t)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let s=r.columns,o=r.clone(),i=e.columns,l,h,u,a;for(u=0;u<i;u++)for(h=0;h<s;h++){for(a=0,l=u;l<t;l++)a+=e.get(l,u)*o.get(l,h);for(a=-a/e.get(u,u),l=u;l<t;l++)o.set(l,h,o.get(l,h)+a*e.get(l,u))}for(u=i-1;u>=0;u--){for(h=0;h<s;h++)o.set(u,h,o.get(u,h)/this.Rdiag[u]);for(l=0;l<u;l++)for(h=0;h<s;h++)o.set(l,h,o.get(l,h)-o.get(u,h)*e.get(l,u))}return o.subMatrix(0,i-1,0,s-1)}isFullRank(){let r=this.QR.columns;for(let e=0;e<r;e++)if(this.Rdiag[e]===0)return!1;return!0}get upperTriangularMatrix(){let r=this.QR,e=r.columns,t=new j(e,e),s,o;for(s=0;s<e;s++)for(o=0;o<e;o++)s<o?t.set(s,o,r.get(s,o)):s===o?t.set(s,o,this.Rdiag[s]):t.set(s,o,0);return t}get orthogonalMatrix(){let r=this.QR,e=r.rows,t=r.columns,s=new j(e,t),o,i,l,h;for(l=t-1;l>=0;l--){for(o=0;o<e;o++)s.set(o,l,0);for(s.set(l,l,1),i=l;i<t;i++)if(r.get(l,l)!==0){for(h=0,o=l;o<e;o++)h+=r.get(o,l)*s.get(o,i);for(h=-h/r.get(l,l),o=l;o<e;o++)s.set(o,i,s.get(o,i)+h*r.get(o,l))}}return s}}class ut{constructor(r,e={}){if(r=J.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let t=r.rows,s=r.columns;const{computeLeftSingularVectors:o=!0,computeRightSingularVectors:i=!0,autoTranspose:l=!1}=e;let h=!!o,u=!!i,a=!1,f;if(t<s)if(!l)f=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{f=r.transpose(),t=f.rows,s=f.columns,a=!0;let g=h;h=u,u=g}else f=r.clone();let w=Math.min(t,s),d=Math.min(t+1,s),m=new Float64Array(d),p=new j(t,w),S=new j(s,s),c=new Float64Array(s),M=new Float64Array(t),E=new Float64Array(d);for(let g=0;g<d;g++)E[g]=g;let R=Math.min(t-1,s),I=Math.max(0,Math.min(s-2,t)),q=Math.max(R,I);for(let g=0;g<q;g++){if(g<R){m[g]=0;for(let y=g;y<t;y++)m[g]=st(m[g],f.get(y,g));if(m[g]!==0){f.get(g,g)<0&&(m[g]=-m[g]);for(let y=g;y<t;y++)f.set(y,g,f.get(y,g)/m[g]);f.set(g,g,f.get(g,g)+1)}m[g]=-m[g]}for(let y=g+1;y<s;y++){if(g<R&&m[g]!==0){let v=0;for(let b=g;b<t;b++)v+=f.get(b,g)*f.get(b,y);v=-v/f.get(g,g);for(let b=g;b<t;b++)f.set(b,y,f.get(b,y)+v*f.get(b,g))}c[y]=f.get(g,y)}if(h&&g<R)for(let y=g;y<t;y++)p.set(y,g,f.get(y,g));if(g<I){c[g]=0;for(let y=g+1;y<s;y++)c[g]=st(c[g],c[y]);if(c[g]!==0){c[g+1]<0&&(c[g]=0-c[g]);for(let y=g+1;y<s;y++)c[y]/=c[g];c[g+1]+=1}if(c[g]=-c[g],g+1<t&&c[g]!==0){for(let y=g+1;y<t;y++)M[y]=0;for(let y=g+1;y<t;y++)for(let v=g+1;v<s;v++)M[y]+=c[v]*f.get(y,v);for(let y=g+1;y<s;y++){let v=-c[y]/c[g+1];for(let b=g+1;b<t;b++)f.set(b,y,f.get(b,y)+v*M[b])}}if(u)for(let y=g+1;y<s;y++)S.set(y,g,c[y])}}let k=Math.min(s,t+1);if(R<s&&(m[R]=f.get(R,R)),t<k&&(m[k-1]=0),I+1<k&&(c[I]=f.get(I,k-1)),c[k-1]=0,h){for(let g=R;g<w;g++){for(let y=0;y<t;y++)p.set(y,g,0);p.set(g,g,1)}for(let g=R-1;g>=0;g--)if(m[g]!==0){for(let y=g+1;y<w;y++){let v=0;for(let b=g;b<t;b++)v+=p.get(b,g)*p.get(b,y);v=-v/p.get(g,g);for(let b=g;b<t;b++)p.set(b,y,p.get(b,y)+v*p.get(b,g))}for(let y=g;y<t;y++)p.set(y,g,-p.get(y,g));p.set(g,g,1+p.get(g,g));for(let y=0;y<g-1;y++)p.set(y,g,0)}else{for(let y=0;y<t;y++)p.set(y,g,0);p.set(g,g,1)}}if(u)for(let g=s-1;g>=0;g--){if(g<I&&c[g]!==0)for(let y=g+1;y<s;y++){let v=0;for(let b=g+1;b<s;b++)v+=S.get(b,g)*S.get(b,y);v=-v/S.get(g+1,g);for(let b=g+1;b<s;b++)S.set(b,y,S.get(b,y)+v*S.get(b,g))}for(let y=0;y<s;y++)S.set(y,g,0);S.set(g,g,1)}let T=k-1,V=Number.EPSILON;for(;k>0;){let g,y;for(g=k-2;g>=-1&&g!==-1;g--){const v=Number.MIN_VALUE+V*Math.abs(m[g]+Math.abs(m[g+1]));if(Math.abs(c[g])<=v||Number.isNaN(c[g])){c[g]=0;break}}if(g===k-2)y=4;else{let v;for(v=k-1;v>=g&&v!==g;v--){let b=(v!==k?Math.abs(c[v]):0)+(v!==g+1?Math.abs(c[v-1]):0);if(Math.abs(m[v])<=V*b){m[v]=0;break}}v===g?y=3:v===k-1?y=1:(y=2,g=v)}switch(g++,y){case 1:{let v=c[k-2];c[k-2]=0;for(let b=k-2;b>=g;b--){let O=st(m[b],v),F=m[b]/O,z=v/O;if(m[b]=O,b!==g&&(v=-z*c[b-1],c[b-1]=F*c[b-1]),u)for(let L=0;L<s;L++)O=F*S.get(L,b)+z*S.get(L,k-1),S.set(L,k-1,-z*S.get(L,b)+F*S.get(L,k-1)),S.set(L,b,O)}break}case 2:{let v=c[g-1];c[g-1]=0;for(let b=g;b<k;b++){let O=st(m[b],v),F=m[b]/O,z=v/O;if(m[b]=O,v=-z*c[b],c[b]=F*c[b],h)for(let L=0;L<t;L++)O=F*p.get(L,b)+z*p.get(L,g-1),p.set(L,g-1,-z*p.get(L,b)+F*p.get(L,g-1)),p.set(L,b,O)}break}case 3:{const v=Math.max(Math.abs(m[k-1]),Math.abs(m[k-2]),Math.abs(c[k-2]),Math.abs(m[g]),Math.abs(c[g])),b=m[k-1]/v,O=m[k-2]/v,F=c[k-2]/v,z=m[g]/v,L=c[g]/v,_=((O+b)*(O-b)+F*F)/2,A=b*F*(b*F);let U=0;(_!==0||A!==0)&&(_<0?U=0-Math.sqrt(_*_+A):U=Math.sqrt(_*_+A),U=A/(_+U));let tt=(z+b)*(z-b)+U,rt=z*L;for(let $=g;$<k-1;$++){let Q=st(tt,rt);Q===0&&(Q=Number.MIN_VALUE);let X=tt/Q,K=rt/Q;if($!==g&&(c[$-1]=Q),tt=X*m[$]+K*c[$],c[$]=X*c[$]-K*m[$],rt=K*m[$+1],m[$+1]=X*m[$+1],u)for(let W=0;W<s;W++)Q=X*S.get(W,$)+K*S.get(W,$+1),S.set(W,$+1,-K*S.get(W,$)+X*S.get(W,$+1)),S.set(W,$,Q);if(Q=st(tt,rt),Q===0&&(Q=Number.MIN_VALUE),X=tt/Q,K=rt/Q,m[$]=Q,tt=X*c[$]+K*m[$+1],m[$+1]=-K*c[$]+X*m[$+1],rt=K*c[$+1],c[$+1]=X*c[$+1],h&&$<t-1)for(let W=0;W<t;W++)Q=X*p.get(W,$)+K*p.get(W,$+1),p.set(W,$+1,-K*p.get(W,$)+X*p.get(W,$+1)),p.set(W,$,Q)}c[k-2]=tt;break}case 4:{if(m[g]<=0&&(m[g]=m[g]<0?-m[g]:0,u))for(let v=0;v<=T;v++)S.set(v,g,-S.get(v,g));for(;g<T&&!(m[g]>=m[g+1]);){let v=m[g];if(m[g]=m[g+1],m[g+1]=v,u&&g<s-1)for(let b=0;b<s;b++)v=S.get(b,g+1),S.set(b,g+1,S.get(b,g)),S.set(b,g,v);if(h&&g<t-1)for(let b=0;b<t;b++)v=p.get(b,g+1),p.set(b,g+1,p.get(b,g)),p.set(b,g,v);g++}k--;break}}}if(a){let g=S;S=p,p=g}this.m=t,this.n=s,this.s=m,this.U=p,this.V=S}solve(r){let e=r,t=this.threshold,s=this.s.length,o=j.zeros(s,s);for(let w=0;w<s;w++)Math.abs(this.s[w])<=t?o.set(w,w,0):o.set(w,w,1/this.s[w]);let i=this.U,l=this.rightSingularVectors,h=l.mmul(o),u=l.rows,a=i.rows,f=j.zeros(u,a);for(let w=0;w<u;w++)for(let d=0;d<a;d++){let m=0;for(let p=0;p<s;p++)m+=h.get(w,p)*i.get(d,p);f.set(w,d,m)}return f.mmul(e)}solveForDiagonal(r){return this.solve(j.diag(r))}inverse(){let r=this.V,e=this.threshold,t=r.rows,s=r.columns,o=new j(t,this.s.length);for(let a=0;a<t;a++)for(let f=0;f<s;f++)Math.abs(this.s[f])>e&&o.set(a,f,r.get(a,f)/this.s[f]);let i=this.U,l=i.rows,h=i.columns,u=new j(t,l);for(let a=0;a<t;a++)for(let f=0;f<l;f++){let w=0;for(let d=0;d<h;d++)w+=o.get(a,d)*i.get(f,d);u.set(a,f,w)}return u}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,e=0,t=this.s;for(let s=0,o=t.length;s<o;s++)t[s]>r&&e++;return e}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return j.diag(this.s)}}function _e(n,r=!1){return n=J.checkMatrix(n),r?new ut(n).inverse():Ut(n,j.eye(n.rows))}function Ut(n,r,e=!1){return n=J.checkMatrix(n),r=J.checkMatrix(r),e?new ut(n).solve(r):n.isSquare()?new yt(n).solve(r):new Rt(n).solve(r)}function Mt(n){if(n=j.checkMatrix(n),n.isSquare()){if(n.columns===0)return 1;let r,e,t,s;if(n.columns===2)return r=n.get(0,0),e=n.get(0,1),t=n.get(1,0),s=n.get(1,1),r*s-e*t;if(n.columns===3){let o,i,l;return o=new dt(n,[1,2],[1,2]),i=new dt(n,[1,2],[0,2]),l=new dt(n,[1,2],[0,1]),r=n.get(0,0),e=n.get(0,1),t=n.get(0,2),r*Mt(o)-e*Mt(i)+t*Mt(l)}else return new yt(n).determinant}else throw Error("determinant can only be calculated for a square matrix")}function Qe(n,r){let e=[];for(let t=0;t<n;t++)t!==r&&e.push(t);return e}function Ye(n,r,e,t=1e-9,s=1e-9){if(n>s)return new Array(r.rows+1).fill(0);{let o=r.addRow(e,[0]);for(let i=0;i<o.rows;i++)Math.abs(o.get(i,0))<t&&o.set(i,0,0);return o.to1DArray()}}function Ge(n,r={}){const{thresholdValue:e=1e-9,thresholdError:t=1e-9}=r;n=j.checkMatrix(n);let s=n.rows,o=new j(s,s);for(let i=0;i<s;i++){let l=j.columnVector(n.getRow(i)),h=n.subMatrixRow(Qe(s,i)).transpose(),a=new ut(h).solve(l),f=j.sub(l,h.mmul(a)).abs().max();o.setRow(i,Ye(f,a,i,e,t))}return o}function Je(n,r=Number.EPSILON){if(n=j.checkMatrix(n),n.isEmpty())return n.transpose();let e=new ut(n,{autoTranspose:!0}),t=e.leftSingularVectors,s=e.rightSingularVectors,o=e.diagonal;for(let i=0;i<o.length;i++)Math.abs(o[i])>r?o[i]=1/o[i]:o[i]=0;return s.mmul(j.diag(o).mmul(t.transpose()))}function Xe(n,r=n,e={}){n=new j(n);let t=!1;if(typeof r=="object"&&!j.isMatrix(r)&&!G.isAnyArray(r)?(e=r,r=n,t=!0):r=new j(r),n.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:s=!0}=e;s&&(n=n.center("column"),t||(r=r.center("column")));const o=n.transpose().mmul(r);for(let i=0;i<o.rows;i++)for(let l=0;l<o.columns;l++)o.set(i,l,o.get(i,l)*(1/(n.rows-1)));return o}function Ke(n,r=n,e={}){n=new j(n);let t=!1;if(typeof r=="object"&&!j.isMatrix(r)&&!G.isAnyArray(r)?(e=r,r=n,t=!0):r=new j(r),n.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:s=!0,scale:o=!0}=e;s&&(n.center("column"),t||r.center("column")),o&&(n.scale("column"),t||r.scale("column"));const i=n.standardDeviation("column",{unbiased:!0}),l=t?i:r.standardDeviation("column",{unbiased:!0}),h=n.transpose().mmul(r);for(let u=0;u<h.rows;u++)for(let a=0;a<h.columns;a++)h.set(u,a,h.get(u,a)*(1/(i[u]*l[a]))*(1/(n.rows-1)));return h}class Wt{constructor(r,e={}){const{assumeSymmetric:t=!1}=e;if(r=J.checkMatrix(r),!r.isSquare())throw new Error("Matrix is not a square matrix");if(r.isEmpty())throw new Error("Matrix must be non-empty");let s=r.columns,o=new j(s,s),i=new Float64Array(s),l=new Float64Array(s),h=r,u,a,f=!1;if(t?f=!0:f=r.isSymmetric(),f){for(u=0;u<s;u++)for(a=0;a<s;a++)o.set(u,a,h.get(u,a));Ze(s,l,i,o),xe(s,l,i,o)}else{let w=new j(s,s),d=new Float64Array(s);for(a=0;a<s;a++)for(u=0;u<s;u++)w.set(u,a,h.get(u,a));Ae(s,w,d,o),He(s,l,i,o,w)}this.n=s,this.e=l,this.d=i,this.V=o}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let r=this.n,e=this.e,t=this.d,s=new j(r,r),o,i;for(o=0;o<r;o++){for(i=0;i<r;i++)s.set(o,i,0);s.set(o,o,t[o]),e[o]>0?s.set(o,o+1,e[o]):e[o]<0&&s.set(o,o-1,e[o])}return s}}function Ze(n,r,e,t){let s,o,i,l,h,u,a,f;for(h=0;h<n;h++)e[h]=t.get(n-1,h);for(l=n-1;l>0;l--){for(f=0,i=0,u=0;u<l;u++)f=f+Math.abs(e[u]);if(f===0)for(r[l]=e[l-1],h=0;h<l;h++)e[h]=t.get(l-1,h),t.set(l,h,0),t.set(h,l,0);else{for(u=0;u<l;u++)e[u]/=f,i+=e[u]*e[u];for(s=e[l-1],o=Math.sqrt(i),s>0&&(o=-o),r[l]=f*o,i=i-s*o,e[l-1]=s-o,h=0;h<l;h++)r[h]=0;for(h=0;h<l;h++){for(s=e[h],t.set(h,l,s),o=r[h]+t.get(h,h)*s,u=h+1;u<=l-1;u++)o+=t.get(u,h)*e[u],r[u]+=t.get(u,h)*s;r[h]=o}for(s=0,h=0;h<l;h++)r[h]/=i,s+=r[h]*e[h];for(a=s/(i+i),h=0;h<l;h++)r[h]-=a*e[h];for(h=0;h<l;h++){for(s=e[h],o=r[h],u=h;u<=l-1;u++)t.set(u,h,t.get(u,h)-(s*r[u]+o*e[u]));e[h]=t.get(l-1,h),t.set(l,h,0)}}e[l]=i}for(l=0;l<n-1;l++){if(t.set(n-1,l,t.get(l,l)),t.set(l,l,1),i=e[l+1],i!==0){for(u=0;u<=l;u++)e[u]=t.get(u,l+1)/i;for(h=0;h<=l;h++){for(o=0,u=0;u<=l;u++)o+=t.get(u,l+1)*t.get(u,h);for(u=0;u<=l;u++)t.set(u,h,t.get(u,h)-o*e[u])}}for(u=0;u<=l;u++)t.set(u,l+1,0)}for(h=0;h<n;h++)e[h]=t.get(n-1,h),t.set(n-1,h,0);t.set(n-1,n-1,1),r[0]=0}function xe(n,r,e,t){let s,o,i,l,h,u,a,f,w,d,m,p,S,c,M,E;for(i=1;i<n;i++)r[i-1]=r[i];r[n-1]=0;let R=0,I=0,q=Number.EPSILON;for(u=0;u<n;u++){for(I=Math.max(I,Math.abs(e[u])+Math.abs(r[u])),a=u;a<n&&!(Math.abs(r[a])<=q*I);)a++;if(a>u)do{for(s=e[u],f=(e[u+1]-s)/(2*r[u]),w=st(f,1),f<0&&(w=-w),e[u]=r[u]/(f+w),e[u+1]=r[u]*(f+w),d=e[u+1],o=s-e[u],i=u+2;i<n;i++)e[i]-=o;for(R=R+o,f=e[a],m=1,p=m,S=m,c=r[u+1],M=0,E=0,i=a-1;i>=u;i--)for(S=p,p=m,E=M,s=m*r[i],o=m*f,w=st(f,r[i]),r[i+1]=M*w,M=r[i]/w,m=f/w,f=m*e[i]-M*s,e[i+1]=o+M*(m*s+M*e[i]),h=0;h<n;h++)o=t.get(h,i+1),t.set(h,i+1,M*t.get(h,i)+m*o),t.set(h,i,m*t.get(h,i)-M*o);f=-M*E*S*c*r[u]/d,r[u]=M*f,e[u]=m*f}while(Math.abs(r[u])>q*I);e[u]=e[u]+R,r[u]=0}for(i=0;i<n-1;i++){for(h=i,f=e[i],l=i+1;l<n;l++)e[l]<f&&(h=l,f=e[l]);if(h!==i)for(e[h]=e[i],e[i]=f,l=0;l<n;l++)f=t.get(l,i),t.set(l,i,t.get(l,h)),t.set(l,h,f)}}function Ae(n,r,e,t){let s=0,o=n-1,i,l,h,u,a,f,w;for(f=s+1;f<=o-1;f++){for(w=0,u=f;u<=o;u++)w=w+Math.abs(r.get(u,f-1));if(w!==0){for(h=0,u=o;u>=f;u--)e[u]=r.get(u,f-1)/w,h+=e[u]*e[u];for(l=Math.sqrt(h),e[f]>0&&(l=-l),h=h-e[f]*l,e[f]=e[f]-l,a=f;a<n;a++){for(i=0,u=o;u>=f;u--)i+=e[u]*r.get(u,a);for(i=i/h,u=f;u<=o;u++)r.set(u,a,r.get(u,a)-i*e[u])}for(u=0;u<=o;u++){for(i=0,a=o;a>=f;a--)i+=e[a]*r.get(u,a);for(i=i/h,a=f;a<=o;a++)r.set(u,a,r.get(u,a)-i*e[a])}e[f]=w*e[f],r.set(f,f-1,w*l)}}for(u=0;u<n;u++)for(a=0;a<n;a++)t.set(u,a,u===a?1:0);for(f=o-1;f>=s+1;f--)if(r.get(f,f-1)!==0){for(u=f+1;u<=o;u++)e[u]=r.get(u,f-1);for(a=f;a<=o;a++){for(l=0,u=f;u<=o;u++)l+=e[u]*t.get(u,a);for(l=l/e[f]/r.get(f,f-1),u=f;u<=o;u++)t.set(u,a,t.get(u,a)+l*e[u])}}}function He(n,r,e,t,s){let o=n-1,i=0,l=n-1,h=Number.EPSILON,u=0,a=0,f=0,w=0,d=0,m=0,p=0,S=0,c,M,E,R,I,q,k,T,V,g,y,v,b,O,F;for(c=0;c<n;c++)for((c<i||c>l)&&(e[c]=s.get(c,c),r[c]=0),M=Math.max(c-1,0);M<n;M++)a=a+Math.abs(s.get(c,M));for(;o>=i;){for(R=o;R>i&&(m=Math.abs(s.get(R-1,R-1))+Math.abs(s.get(R,R)),m===0&&(m=a),!(Math.abs(s.get(R,R-1))<h*m));)R--;if(R===o)s.set(o,o,s.get(o,o)+u),e[o]=s.get(o,o),r[o]=0,o--,S=0;else if(R===o-1){if(k=s.get(o,o-1)*s.get(o-1,o),f=(s.get(o-1,o-1)-s.get(o,o))/2,w=f*f+k,p=Math.sqrt(Math.abs(w)),s.set(o,o,s.get(o,o)+u),s.set(o-1,o-1,s.get(o-1,o-1)+u),T=s.get(o,o),w>=0){for(p=f>=0?f+p:f-p,e[o-1]=T+p,e[o]=e[o-1],p!==0&&(e[o]=T-k/p),r[o-1]=0,r[o]=0,T=s.get(o,o-1),m=Math.abs(T)+Math.abs(p),f=T/m,w=p/m,d=Math.sqrt(f*f+w*w),f=f/d,w=w/d,M=o-1;M<n;M++)p=s.get(o-1,M),s.set(o-1,M,w*p+f*s.get(o,M)),s.set(o,M,w*s.get(o,M)-f*p);for(c=0;c<=o;c++)p=s.get(c,o-1),s.set(c,o-1,w*p+f*s.get(c,o)),s.set(c,o,w*s.get(c,o)-f*p);for(c=i;c<=l;c++)p=t.get(c,o-1),t.set(c,o-1,w*p+f*t.get(c,o)),t.set(c,o,w*t.get(c,o)-f*p)}else e[o-1]=T+f,e[o]=T+f,r[o-1]=p,r[o]=-p;o=o-2,S=0}else{if(T=s.get(o,o),V=0,k=0,R<o&&(V=s.get(o-1,o-1),k=s.get(o,o-1)*s.get(o-1,o)),S===10){for(u+=T,c=i;c<=o;c++)s.set(c,c,s.get(c,c)-T);m=Math.abs(s.get(o,o-1))+Math.abs(s.get(o-1,o-2)),T=V=.75*m,k=-.4375*m*m}if(S===30&&(m=(V-T)/2,m=m*m+k,m>0)){for(m=Math.sqrt(m),V<T&&(m=-m),m=T-k/((V-T)/2+m),c=i;c<=o;c++)s.set(c,c,s.get(c,c)-m);u+=m,T=V=k=.964}for(S=S+1,I=o-2;I>=R&&(p=s.get(I,I),d=T-p,m=V-p,f=(d*m-k)/s.get(I+1,I)+s.get(I,I+1),w=s.get(I+1,I+1)-p-d-m,d=s.get(I+2,I+1),m=Math.abs(f)+Math.abs(w)+Math.abs(d),f=f/m,w=w/m,d=d/m,!(I===R||Math.abs(s.get(I,I-1))*(Math.abs(w)+Math.abs(d))<h*(Math.abs(f)*(Math.abs(s.get(I-1,I-1))+Math.abs(p)+Math.abs(s.get(I+1,I+1))))));)I--;for(c=I+2;c<=o;c++)s.set(c,c-2,0),c>I+2&&s.set(c,c-3,0);for(E=I;E<=o-1&&(O=E!==o-1,E!==I&&(f=s.get(E,E-1),w=s.get(E+1,E-1),d=O?s.get(E+2,E-1):0,T=Math.abs(f)+Math.abs(w)+Math.abs(d),T!==0&&(f=f/T,w=w/T,d=d/T)),T!==0);E++)if(m=Math.sqrt(f*f+w*w+d*d),f<0&&(m=-m),m!==0){for(E!==I?s.set(E,E-1,-m*T):R!==I&&s.set(E,E-1,-s.get(E,E-1)),f=f+m,T=f/m,V=w/m,p=d/m,w=w/f,d=d/f,M=E;M<n;M++)f=s.get(E,M)+w*s.get(E+1,M),O&&(f=f+d*s.get(E+2,M),s.set(E+2,M,s.get(E+2,M)-f*p)),s.set(E,M,s.get(E,M)-f*T),s.set(E+1,M,s.get(E+1,M)-f*V);for(c=0;c<=Math.min(o,E+3);c++)f=T*s.get(c,E)+V*s.get(c,E+1),O&&(f=f+p*s.get(c,E+2),s.set(c,E+2,s.get(c,E+2)-f*d)),s.set(c,E,s.get(c,E)-f),s.set(c,E+1,s.get(c,E+1)-f*w);for(c=i;c<=l;c++)f=T*t.get(c,E)+V*t.get(c,E+1),O&&(f=f+p*t.get(c,E+2),t.set(c,E+2,t.get(c,E+2)-f*d)),t.set(c,E,t.get(c,E)-f),t.set(c,E+1,t.get(c,E+1)-f*w)}}}if(a!==0){for(o=n-1;o>=0;o--)if(f=e[o],w=r[o],w===0)for(R=o,s.set(o,o,1),c=o-1;c>=0;c--){for(k=s.get(c,c)-f,d=0,M=R;M<=o;M++)d=d+s.get(c,M)*s.get(M,o);if(r[c]<0)p=k,m=d;else if(R=c,r[c]===0?s.set(c,o,k!==0?-d/k:-d/(h*a)):(T=s.get(c,c+1),V=s.get(c+1,c),w=(e[c]-f)*(e[c]-f)+r[c]*r[c],q=(T*m-p*d)/w,s.set(c,o,q),s.set(c+1,o,Math.abs(T)>Math.abs(p)?(-d-k*q)/T:(-m-V*q)/p)),q=Math.abs(s.get(c,o)),h*q*q>1)for(M=c;M<=o;M++)s.set(M,o,s.get(M,o)/q)}else if(w<0)for(R=o-1,Math.abs(s.get(o,o-1))>Math.abs(s.get(o-1,o))?(s.set(o-1,o-1,w/s.get(o,o-1)),s.set(o-1,o,-(s.get(o,o)-f)/s.get(o,o-1))):(F=bt(0,-s.get(o-1,o),s.get(o-1,o-1)-f,w),s.set(o-1,o-1,F[0]),s.set(o-1,o,F[1])),s.set(o,o-1,0),s.set(o,o,1),c=o-2;c>=0;c--){for(g=0,y=0,M=R;M<=o;M++)g=g+s.get(c,M)*s.get(M,o-1),y=y+s.get(c,M)*s.get(M,o);if(k=s.get(c,c)-f,r[c]<0)p=k,d=g,m=y;else if(R=c,r[c]===0?(F=bt(-g,-y,k,w),s.set(c,o-1,F[0]),s.set(c,o,F[1])):(T=s.get(c,c+1),V=s.get(c+1,c),v=(e[c]-f)*(e[c]-f)+r[c]*r[c]-w*w,b=(e[c]-f)*2*w,v===0&&b===0&&(v=h*a*(Math.abs(k)+Math.abs(w)+Math.abs(T)+Math.abs(V)+Math.abs(p))),F=bt(T*d-p*g+w*y,T*m-p*y-w*g,v,b),s.set(c,o-1,F[0]),s.set(c,o,F[1]),Math.abs(T)>Math.abs(p)+Math.abs(w)?(s.set(c+1,o-1,(-g-k*s.get(c,o-1)+w*s.get(c,o))/T),s.set(c+1,o,(-y-k*s.get(c,o)-w*s.get(c,o-1))/T)):(F=bt(-d-V*s.get(c,o-1),-m-V*s.get(c,o),p,w),s.set(c+1,o-1,F[0]),s.set(c+1,o,F[1]))),q=Math.max(Math.abs(s.get(c,o-1)),Math.abs(s.get(c,o))),h*q*q>1)for(M=c;M<=o;M++)s.set(M,o-1,s.get(M,o-1)/q),s.set(M,o,s.get(M,o)/q)}for(c=0;c<n;c++)if(c<i||c>l)for(M=c;M<n;M++)t.set(c,M,s.get(c,M));for(M=n-1;M>=i;M--)for(c=i;c<=l;c++){for(p=0,E=i;E<=Math.min(M,l);E++)p=p+t.get(c,E)*s.get(E,M);t.set(c,M,p)}}}function bt(n,r,e,t){let s,o;return Math.abs(e)>Math.abs(t)?(s=t/e,o=e+s*t,[(n+s*r)/o,(r-s*n)/o]):(s=e/t,o=t+s*e,[(s*n+r)/o,(s*r-n)/o])}class _t{constructor(r){if(r=J.checkMatrix(r),!r.isSymmetric())throw new Error("Matrix is not symmetric");let e=r,t=e.rows,s=new j(t,t),o=!0,i,l,h;for(l=0;l<t;l++){let u=0;for(h=0;h<l;h++){let a=0;for(i=0;i<h;i++)a+=s.get(h,i)*s.get(l,i);a=(e.get(l,h)-a)/s.get(h,h),s.set(l,h,a),u=u+a*a}for(u=e.get(l,l)-u,o&&(o=u>0),s.set(l,l,Math.sqrt(Math.max(u,0))),h=l+1;h<t;h++)s.set(l,h,0)}this.L=s,this.positiveDefinite=o}isPositiveDefinite(){return this.positiveDefinite}solve(r){r=J.checkMatrix(r);let e=this.L,t=e.rows;if(r.rows!==t)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let s=r.columns,o=r.clone(),i,l,h;for(h=0;h<t;h++)for(l=0;l<s;l++){for(i=0;i<h;i++)o.set(h,l,o.get(h,l)-o.get(i,l)*e.get(h,i));o.set(h,l,o.get(h,l)/e.get(h,h))}for(h=t-1;h>=0;h--)for(l=0;l<s;l++){for(i=h+1;i<t;i++)o.set(h,l,o.get(h,l)-o.get(i,l)*e.get(i,h));o.set(h,l,o.get(h,l)/e.get(h,h))}return o}get lowerTriangularMatrix(){return this.L}}class Qt{constructor(r,e={}){r=J.checkMatrix(r);let{Y:t}=e;const{scaleScores:s=!1,maxIterations:o=1e3,terminationCriteria:i=1e-10}=e;let l;if(t){if(G.isAnyArray(t)&&typeof t[0]=="number"?t=j.columnVector(t):t=J.checkMatrix(t),t.rows!==r.rows)throw new Error("Y should have the same number of rows as X");l=t.getColumnVector(0)}else l=r.getColumnVector(0);let h=1,u,a,f,w;for(let d=0;d<o&&h>i;d++)f=r.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),f=f.div(f.norm()),u=r.mmul(f).div(f.transpose().mmul(f).get(0,0)),d>0&&(h=u.clone().sub(w).pow(2).sum()),w=u.clone(),t?(a=t.transpose().mmul(u).div(u.transpose().mmul(u).get(0,0)),a=a.div(a.norm()),l=t.mmul(a).div(a.transpose().mmul(a).get(0,0))):l=u;if(t){let d=r.transpose().mmul(u).div(u.transpose().mmul(u).get(0,0));d=d.div(d.norm());let m=r.clone().sub(u.clone().mmul(d.transpose())),p=l.transpose().mmul(u).div(u.transpose().mmul(u).get(0,0)),S=t.clone().sub(u.clone().mulS(p.get(0,0)).mmul(a.transpose()));this.t=u,this.p=d.transpose(),this.w=f.transpose(),this.q=a,this.u=l,this.s=u.transpose().mmul(u),this.xResidual=m,this.yResidual=S,this.betas=p}else this.w=f.transpose(),this.s=u.transpose().mmul(u).sqrt(),s?this.t=u.clone().div(this.s.get(0,0)):this.t=u,this.xResidual=r.sub(u.mmul(f.transpose()))}}D.AbstractMatrix=N,D.CHO=_t,D.CholeskyDecomposition=_t,D.DistanceMatrix=pt,D.EVD=Wt,D.EigenvalueDecomposition=Wt,D.LU=yt,D.LuDecomposition=yt;var Yt=D.Matrix=j;D.MatrixColumnSelectionView=Pe,D.MatrixColumnView=Ve,D.MatrixFlipColumnView=ze,D.MatrixFlipRowView=Ce,D.MatrixRowSelectionView=Le,D.MatrixRowView=Oe,D.MatrixSelectionView=dt,D.MatrixSubView=Be,D.MatrixTransposeView=Ue,D.NIPALS=Qt,D.Nipals=Qt,D.QR=Rt,D.QrDecomposition=Rt,D.SVD=ut,D.SingularValueDecomposition=ut,D.SymmetricMatrix=ot,D.WrapperMatrix1D=Bt,D.WrapperMatrix2D=J,D.correlation=Ke,D.covariance=Xe;var Gt=D.default=j;D.determinant=Mt;var ts=D.inverse=_e;D.linearDependencies=Ge,D.pseudoInverse=Je,D.solve=Ut,D.wrap=We;const It=Yt;Gt.Matrix&&Gt.Matrix;const es=ts;function ss(n,r,e,t,s,o){const i=e.length,l=n.x.length;let h=It.zeros(i,l),u=0;for(let a=0;a<i;a++){if(t[a]===0)continue;let f=t[a],w=e.slice();w[a]+=f;let d=s(w);if(o){w=e.slice(),w[a]-=f,f*=2;let m=s(w);for(let p=0;p<l;p++)h.set(u,p,(m(n.x[p])-d(n.x[p]))/f)}else for(let m=0;m<l;m++)h.set(u,m,(r[m]-d(n.x[m]))/f);u++}return h}function rs(n,r){const e=n.x.length;let t=new It(e,1);for(let s=0;s<e;s++)t.set(s,0,n.y[s]-r[s]);return t}function os(n,r,e,t,s,o,i){let l=e,h=It.eye(r.length,r.length,l);const u=s(r);let a=new Float64Array(n.x.length);for(let S=0;S<n.x.length;S++)a[S]=u(n.x[S]);let f=ss(n,a,r,t,s,o),w=rs(n,a),d=es(h.add(f.mmul(f.transpose().scale("row",{scale:i})))),m=f.mmul(w.scale("row",{scale:i}));return{perturbations:d.mmul(m),jacobianWeigthResidualError:m}}function ns(n,r,e={}){let{checkTimeout:t,minValues:s,maxValues:o,parameters:i,weightSquare:l,damping:h,dampingStepUp:u,dampingStepDown:a,maxIterations:f,errorTolerance:w,centralDifference:d,gradientDifference:m,improvementThreshold:p}=Zt(n,r,e),S=$t(n,i,r,l),c=S<=w,M=0;for(;M<f&&!c;M++){let E=S,{perturbations:R,jacobianWeigthResidualError:I}=os(n,i,h,m,r,d,l);for(let k=0;k<i.length;k++)i[k]=Math.min(Math.max(s[k],i[k]-R.get(k,0)),o[k]);if(S=$t(n,i,r,l),isNaN(S))break;if((E-S)/R.transpose().mmul(R.mulS(h).add(I)).get(0,0)>p?h=Math.max(h/a,1e-7):(S=E,h=Math.min(h*u,1e7)),t())throw new Error(`The execution time is over to ${e.timeout} seconds`);c=S<=w}return{parameterValues:i,parameterError:S,iterations:M}}self.onmessage=n=>{const{experimentalData:r,structure:e,paramsToRefine:t,wavelength:s}=n.data,o=r.map(u=>u.angle),i=r.map(u=>u.backgroundSubtracted??u.intensity),l=[1,e.a,e.b,e.c],h=([u,a,f,w])=>{const d={...e,a,b:f,c:w};return P(d,o,s,u)};try{const a=ns({x:i,y:i},h,{damping:1.5,initialValues:l,gradientDifference:.1,maxIterations:20,errorTolerance:1e-5}),[f,w,d,m]=a.parameterValues,p={...e,a:w,b:d,c:m},S=P(p,o,s,f);let c=0,M=0;i.forEach((I,q)=>{const k=I-S[q];c+=k*k,M+=I*I});const E=Math.sqrt(c/M),R={calculatedIntensity:S,refinedStructure:p,rwp:E,refinedScale:f};self.postMessage(R)}catch(u){console.error("Refinement failed",u)}}})();
